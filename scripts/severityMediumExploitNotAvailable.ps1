####
#
# Description: Script to demonstrate using Tenable.io API's.
#
# Requirement: You must have tenable_io.xml on your system as this script will pull your Access Key and Secret Key from that file. 
#              Place the file in a location that is secure yet this script has the ability read.
#
# Version: .1 Initial Script February 21, 2018
#		        Create report.
#
#####

# Import configuration settings
[xml]$ConfigFile = Get-Content C:\{path_to_file}\config\tenable_io.xml
$Tenableio = $ConfigFile.Settings.Access.Url
$access = $ConfigFile.Settings.Access.AccessKey
$secret = $ConfigFile.Settings.Access.SecretKey

# Header
$headers = "accessKey=$access; secretKey=$secret"

# Request a report to be generated
function listSystems($reportFormat, $reportValue, $Reportchapter, $pluginID) {
  $object = "workbenches/export?format=$reportFormat&report=$reportValue&chapter=$reportChapter&plugin_id=$pluginID"
  $response = Invoke-RestMethod -Method Get -Uri $Tenableio/$object -Header @{ "X-ApiKeys" = $headers }
  Write-Host $response[0].outputs
  return $response[0].file
}

# Request a report to be generated
function Download-Report($inFile, $title, $fileExtension) {
  $outFile=($title + "." + $fileExtension)
  # Query Tenable.io to see if the requested file for status. 
  DO {
    $object = "workbenches/export/$inFile/status"
    $response = Invoke-RestMethod -Method Get -Uri $Tenableio/$object -Header @{ "X-ApiKeys" = $headers }
    Write-Host $response[0].status
  }

  Until ($response[0].status -eq "ready")
  # Once the file is ready, pull down and save to the local system.
  $object = "workbenches/export/$inFile/download"
  Write-Host $object
  $response = Invoke-RestMethod -Method Get -Uri $Tenableio/$object -Header @{ "X-ApiKeys" = $headers } -OutFile $outFile
}

function reportSeverity($authenticated, $exploitable, $severity, $title) {
  $outFile=($title + ".csv")
  $object = "workbenches/vulnerabilities?authenticated=$authenticated&exploitable=$exploitable&resolvable=false&severity=$severity"
  $response = Invoke-RestMethod -Method Get -Uri $Tenableio/$object -Header @{ "X-ApiKeys" = $headers }
  $response.vulnerabilities | select plugin_id, plugin_name, plugin_family, severity, count, accepted_count, recasted_count | export-csv $outFile -noType
}

## Create list of Plugins and the aggregate number of times found based upon criteria:
## Name of function to call (reportSeverity)
## First variable is authenticated (true or false)
## Second variable is exploitable (true or false)
## Third variable is severity (critical, high, medium, low or info)
## Fourth variable is name you want the report to be. Extension .csv will be appended to report name.
echo "Generating report of plugins that have a severity of medium and no known exploit."
reportSeverity false false medium list_medium_plugins_with_no_exploit
